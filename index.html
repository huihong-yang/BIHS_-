
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>가상 주식 - 축제</title>
  <style>
    :root { --bg:#0e1116; --card:#171b22; --ink:#e8eef6; --muted:#93a0b4; --accent:#7aa2ff; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, Apple Color Emoji, Segoe UI Emoji; background:var(--bg); color:var(--ink); }
    header{ padding:16px; border-bottom:1px solid #222; position:sticky; top:0; background:var(--bg); z-index:10; }
    .wrap{ padding:16px; max-width:900px; margin:0 auto; }
    .card{ background:var(--card); border:1px solid #222; border-radius:16px; padding:16px; }
    h1{ font-size:20px; margin:0 0 8px; }
    h2{ font-size:16px; margin:0 0 8px; color:var(--muted); }
    button{ padding:12px 14px; border-radius:12px; border:1px solid #333; background:#11161f; color:var(--ink); font-weight:600; }
    button.primary{ background:var(--accent); color:#0b1220; border-color:transparent; }
    button:disabled{ opacity:.5; }
    input, select{ width:100%; padding:12px 10px; background:#0d1117; border:1px solid #2a2f39; border-radius:12px; color:var(--ink); }
    .grid{ display:grid; gap:12px; }
    .g2{ grid-template-columns: 1fr 1fr; }
    .row{ display:flex; align-items:center; gap:8px; }
    .muted{ color:var(--muted); font-size:12px; }
    .price{ font-weight:800; font-size:28px; }
    .list{ display:flex; flex-direction:column; gap:10px; max-height: 280px; overflow:auto; }
    .pill{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a2f39; background:#0d1117; }
    .flex{ display:flex; align-items:center; gap:8px; }
    .space{ height:12px; }
  </style>
</head>
<body>
  <header class="wrap">
    <div class="row">
      <h1>🎈 가상 주식 시장</h1>
      <span class="pill">학교 축제</span>
    </div>
    <div class="muted">수요·공급에 따라 가격이 자동으로 변해요. 변동계수 ↑ → 가격 갱신이 더 잦고, 체결 영향도 커집니다.</div>
  </header>
  <div class="wrap grid">
    <div class="card" id="authCard">
      <h2>닉네임</h2>
      <div class="grid g2">
        <input id="nickname" placeholder="예: hong123" />
        <button id="joinBtn" class="primary">입장</button>
      </div>
      <div class="muted">* 같은 닉네임으로 다시 접속하면 동일 계정에 이어서 접속돼요.</div>
    </div>

    <div class="card" id="marketCard" style="display:none">
      <div class="grid g2">
        <div>
          <h2>종목</h2>
          <select id="ticker"></select>
        </div>
        <div>
          <h2>현재가</h2>
          <div class="price"><span id="price">-</span> 원</div>
          <div class="muted" id="volInfo"></div>
        </div>
      </div>

      <div class="space"></div>

      <div class="grid g2">
        <div>
          <h2>수량</h2>
          <input id="qty" type="number" value="1" min="1" />
        </div>
        <div class="grid g2">
          <button id="buyBtn" class="primary">매수</button>
          <button id="sellBtn">매도</button>
        </div>
      </div>

      <div class="space"></div>

      <div class="grid g2">
        <div class="card">
          <h2>내 정보</h2>
          <div class="row"><div class="muted">잔액</div><div id="balance">-</div></div>
          <div class="space"></div>
          <div class="muted">보유</div>
          <div class="list" id="holdings"></div>
        </div>
        <div class="card">
          <h2>체결 내역 (최근)</h2>
          <div class="list" id="history"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const authCard = $('#authCard');
    const marketCard = $('#marketCard');
    const nicknameInput = $('#nickname');
    const joinBtn = $('#joinBtn');

    const tickerSel = $('#ticker');
    const priceEl = $('#price');
    const volInfo = $('#volInfo');
    const qtyInput = $('#qty');
    const buyBtn = $('#buyBtn');
    const sellBtn = $('#sellBtn');

    const balanceEl = $('#balance');
    const holdingsEl = $('#holdings');
    const historyEl = $('#history');

    let currentUser = null;
    let stocks = {};
    let currentTicker = 'FEST';

    function formatWon(n){
      return Number(n).toLocaleString('ko-KR', { maximumFractionDigits: 2 });
    }

    function renderStocks() {
      tickerSel.innerHTML = '';
      Object.entries(stocks).forEach(([t, s]) => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = `${t} · ${s.name}`;
        tickerSel.appendChild(opt);
      });
      if (!stocks[currentTicker]) currentTicker = Object.keys(stocks)[0];
      tickerSel.value = currentTicker;
      updatePriceUI();
    }

    function updatePriceUI(){
      const s = stocks[currentTicker];
      if (!s) return;
      priceEl.textContent = formatWon(s.price);
      volInfo.textContent = `변동계수: ${s.volatility.toFixed(1)}  ${s.paused ? '· 일시정지' : ''}`;
    }

    function renderUser(u){
      currentUser = u;
      balanceEl.textContent = formatWon(u.balance) + ' 원';
      holdingsEl.innerHTML = '';
      const entries = Object.entries(u.holdings || {});
      if (!entries.length){ holdingsEl.innerHTML = '<div class="muted">보유 없음</div>'; }
      for (const [t, q] of entries){
        const div = document.createElement('div');
        div.textContent = `${t}: ${q}주`;
        holdingsEl.appendChild(div);
      }
      historyEl.innerHTML = '';
      for (const h of u.history || []){
        const item = document.createElement('div');
        const date = new Date(h.ts);
        item.className='row';
        item.innerHTML = `<span class="pill">${h.side==='buy'?'매수':'매도'}</span>
                          <span>${h.ticker}</span>
                          <span>${h.qty}주</span>
                          <span>@ ${formatWon(h.price)}</span>
                          <span class="muted">${date.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'})}</span>`;
        historyEl.prepend(item);
      }
    }

    function join(){
      const nick = nicknameInput.value.trim();
      if (!nick) { alert('닉네임을 입력하세요.'); return; }
      localStorage.setItem('vsf:nick', nick);
      socket.emit('register', nick);
    }

    joinBtn.addEventListener('click', join);
    nicknameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') join(); });

    tickerSel.addEventListener('change', () => {
      currentTicker = tickerSel.value;
      updatePriceUI();
    });

    buyBtn.addEventListener('click', () => {
      const qty = parseInt(qtyInput.value || '0', 10);
      socket.emit('buy', { ticker: currentTicker, qty });
    });
    sellBtn.addEventListener('click', () => {
      const qty = parseInt(qtyInput.value || '0', 10);
      socket.emit('sell', { ticker: currentTicker, qty });
    });

    // Socket handlers
    socket.on('state:init', ({ stocks: s, user }) => {
      stocks = s;
      renderStocks();
      if (user) {
        renderUser(user);
        authCard.style.display='none';
        marketCard.style.display='block';
      }
    });
    socket.on('price:all', ({ stocks: s }) => {
      stocks = s;
      renderStocks();
    });
    socket.on('price:update', ({ ticker, price }) => {
      if (stocks[ticker]) {
        stocks[ticker].price = price;
        if (ticker === currentTicker) updatePriceUI();
      }
    });
    socket.on('user:update', (u) => renderUser(u));
    socket.on('trade:result', (res) => {
      if (!res.ok) alert(res.error);
    });

    // Auto load nickname if saved
    const saved = localStorage.getItem('vsf:nick');
    if (saved) { nicknameInput.value = saved; join(); }
  </script>
</body>
</html>
