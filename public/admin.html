
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>관리자 - 가상 주식</title>
  <style>
    :root { --bg:#0e1116; --card:#171b22; --ink:#e8eef6; --muted:#93a0b4; --accent:#7aa2ff; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, Apple Color Emoji, Segoe UI Emoji; background:var(--bg); color:var(--ink); }
    header{ padding:16px; border-bottom:1px solid #222; position:sticky; top:0; background:var(--bg); z-index:10; }
    .wrap{ padding:16px; max-width:1000px; margin:0 auto; }
    .card{ background:var(--card); border:1px solid #222; border-radius:16px; padding:16px; }
    h1{ font-size:20px; margin:0 0 8px; }
    h2{ font-size:16px; margin:0 0 8px; color:var(--muted); }
    button{ padding:10px 12px; border-radius:10px; border:1px solid #333; background:#11161f; color:var(--ink); font-weight:600; }
    button.primary{ background:var(--accent); color:#0b1220; border-color:transparent; }
    input, select{ width:100%; padding:10px 10px; background:#0d1117; border:1px solid #2a2f39; border-radius:10px; color:var(--ink); }
    .grid{ display:grid; gap:12px; }
    .g2{ grid-template-columns: 1fr 1fr; }
    .g3{ grid-template-columns: 1fr 1fr 1fr; }
    .row{ display:flex; align-items:center; gap:8px; }
    .muted{ color:var(--muted); font-size:12px; }
    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td { border-bottom:1px solid #222; padding:8px; text-align:left; }
    .pill{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a2f39; background:#0d1117; }
  </style>
</head>
<body>
  <header class="wrap">
    <div class="row">
      <h1>관리자 콘솔</h1>
      <span class="pill">축제 운영</span>
    </div>
    <div class="muted">관리자 키를 입력해 주세요.</div>
  </header>
  <div class="wrap grid">
    <div class="card" id="authCard">
      <div class="grid g2">
        <input id="key" placeholder="ADMIN_KEY" />
        <button id="authBtn" class="primary">접속</button>
      </div>
    </div>

    <div class="card" id="panel" style="display:none">
      <h2>시장 제어</h2>
      <div class="grid g3">
        <div class="row">
          <input id="newTicker" placeholder="예: GAME" />
          <input id="newName" placeholder="이름" />
        </div>
        <div class="row">
          <input id="newPrice" type="number" placeholder="기준가 (예: 100)" />
          <input id="newVol" type="number" step="0.1" placeholder="변동계수 (0.2~5)" />
        </div>
        <button id="createBtn" class="primary">종목 추가</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="resetBtn">전체 초기화</button>
      </div>

      <h2 style="margin-top:16px;">종목 관리</h2>
      <table class="table" id="stocksTable">
        <thead>
          <tr><th>티커</th><th>이름</th><th>가격</th><th>변동계수</th><th>상태</th><th>조작</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2 style="margin-top:16px;">유저 잔액 조정</h2>
      <div class="grid g3">
        <input id="cashNick" placeholder="닉네임" />
        <input id="cashAmount" type="number" placeholder="금액(+/-)" />
        <button id="cashBtn">지급/차감</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const $ = (s) => document.querySelector(s);
    const admin = io('/admin');
    const authCard = $('#authCard');
    const panel = $('#panel');
    const tbody = $('#stocksTable tbody');

    $('#authBtn').onclick = () => {
      admin.emit('auth', { key: $('#key').value.trim() });
    };

    admin.on('auth:ok', ({ stocks }) => {
      authCard.style.display='none';
      panel.style.display='block';
      render(stocks);
    });
    admin.on('auth:fail', () => alert('관리자 키가 틀렸습니다.'));

    admin.on('stocks', (stocks) => render(stocks));

    function render(stocks){
      tbody.innerHTML = '';
      Object.entries(stocks).forEach(([t, s]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t}</td>
          <td>${s.name}</td>
          <td>
            <div class="row">
              <input data-t="${t}" class="priceInput" type="number" value="${s.price}"/>
              <button data-t="${t}" class="setPrice">설정</button>
            </div>
          </td>
          <td>
            <div class="row">
              <input data-t="${t}" class="volInput" type="number" step="0.1" value="${s.volatility}"/>
              <button data-t="${t}" class="setVol">설정</button>
            </div>
          </td>
          <td>${s.paused ? '일시정지' : '거래중'}</td>
          <td>
            <div class="row">
              <button data-t="${t}" class="toggle">${s.paused ? '재개' : '일시정지'}</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.setPrice').forEach(btn => {
        btn.onclick = () => {
          const t = btn.getAttribute('data-t');
          const val = Number(document.querySelector(`.priceInput[data-t="${t}"]`).value);
          admin.emit('setPrice', { ticker: t, price: val });
        };
      });
      document.querySelectorAll('.setVol').forEach(btn => {
        btn.onclick = () => {
          const t = btn.getAttribute('data-t');
          const val = Number(document.querySelector(`.volInput[data-t="${t}"]`).value);
          admin.emit('setVolatility', { ticker: t, volatility: val });
        };
      });
      document.querySelectorAll('.toggle').forEach(btn => {
        btn.onclick = () => {
          const t = btn.getAttribute('data-t');
          admin.emit('togglePause', { ticker: t });
        };
      });
    }

    $('#createBtn').onclick = () => {
      const ticker = $('#newTicker').value.trim();
      const name = $('#newName').value.trim();
      const price = Number($('#newPrice').value);
      const vol = Number($('#newVol').value || 1.0);
      admin.emit('createStock', { ticker, name, price, volatility: vol });
    };

    admin.on('createStock:result', ({ ok }) => {
      if (!ok) alert('생성 실패: 티커가 중복이거나 입력이 올바르지 않아요.');
    });

    $('#resetBtn').onclick = () => {
      if (confirm('정말 전체 초기화 할까요? 모든 유저가 초기화됩니다.')) {
        admin.emit('resetAll');
      }
    };

    $('#cashBtn').onclick = () => {
      const nick = $('#cashNick').value.trim();
      const amount = Number($('#cashAmount').value || 0);
      if (!nick || !amount) return alert('닉네임과 금액을 입력하세요.');
      admin.emit('giveCash', { nick, amount });
      alert('처리되었습니다.');
    };
  </script>
</body>
</html>
